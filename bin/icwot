#!/usr/bin/env ruby

# A simple tool to run server on the client side

require 'socket'
require 'timeout'
require 'rest-client'
require 'json'
require 'icwot'
require 'icwot/client'
require 'icwot/console'

console = Console.new

unless console.parse
  puts console.errors
  exit 0
end

if Icwot.is_port_open?('localhost', console.port)
  puts 'Port already in use ! Try another one.'
  exit 0
end

client = Client.new(port: console.port, content_type: console.produces)

RestClient.post console.url, client.to_s, console.header

#TODO handle exception from RestClient

Icwot.run(console.port, console.log_path)